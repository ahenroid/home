#!/bin/bash
# -*- mode: Shell-script;-*-

if [[ ! -d ~/.rbenv ]]; then
    git clone https://github.com/rbenv/rbenv.git ~/.rbenv
    git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
    cd ~/.rbenv && src/configure && make -C src
fi

# build various ruby versions
for ver in 2.1.10 2.2.5 2.3.1; do
    if [[ ! -d ~/.rbenv/versions/$ver ]]; then
	export RUBY_CONFIGURE_OPTS="--enable-shared"
	~/.rbenv/bin/rbenv install $ver || break
    fi
    ~/.rbenv/bin/rbenv global $ver || break
    if [[ ! -d ~/proj/ruby ]]; then mkdir -p ~/proj/ruby; fi
    if [[ ! -d ~/proj/ruby/ruby-$ver ]]; then
	cd ~/proj/ruby
	verbase=`echo $ver | awk -F. '{printf "%d.%d", $1, $2}'`
	wget https://cache.ruby-lang.org/pub/ruby/$verbase/ruby-$ver.tar.bz2 \
	    && bunzip2 -c ruby-$ver.tar.bz2 | tar xf - \
	    && rm ruby-$ver.tar.bz2
    fi
done
