#!/bin/bash
# -*- mode: Shell-script;-*-

ME=`basename $0`

# Ruby versions
RUBY_VERS="2.1.10 2.2.5 2.3.1"

# install rbenv
if [ ! -d ~/.rbenv ]; then
    echo "$ME: installing rbenv"
    git clone https://github.com/rbenv/rbenv.git ~/.rbenv
    git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
    cd ~/.rbenv && src/configure && make -C src
fi

# build various Ruby versions
for ver in $RUBY_VERS; do
    if [ ! -d ~/.rbenv/versions/$ver ]; then
	echo "$ME: installing Ruby $ver"
	export RUBY_CONFIGURE_OPTS="--enable-shared"
	~/.rbenv/bin/rbenv install $ver || break
    fi

    if [ ! -d ~/proj/ruby/ruby-$ver ]; then
	echo "$ME: installing Ruby $ver source"
	if [ ! -d ~/proj/ruby ]; then mkdir -p ~/proj/ruby; fi
	cd ~/proj/ruby
	verbase=`echo $ver | awk -F. '{printf "%d.%d", $1, $2}'`
	wget https://cache.ruby-lang.org/pub/ruby/$verbase/ruby-$ver.tar.bz2 \
	    && bunzip2 -c ruby-$ver.tar.bz2 | tar xf - \
	    && rm ruby-$ver.tar.bz2
    fi

    echo "$ME: configuring Ruby $ver"
    ~/.rbenv/bin/rbenv global $ver || break
    for pkg in bundler rdoc; do
	if ! gem list --local | grep -q "$pkg"; then
	    echo "$ME: installing $pkg"
	    gem install $pkg > /dev/null
	fi
    done
    if [ -d ~/proj/puppet ]; then
	cd ~/proj/puppet
	bundle install > /dev/null
    fi
done
